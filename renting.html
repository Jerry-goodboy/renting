<html>
<head>
	<meta charset="UTF-8">
  	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

	<title>estate</title>

	<link rel="stylesheet" href="https://js.arcgis.com/3.17/esri/css/esri.css">
	<script src="https://js.arcgis.com/3.17/"></script>

	<link rel="stylesheet" href="css/jquery.range.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">

	<script src="js/jquery.js"></script>
	<script src="js/echarts-all.js"></script>
	<script src="js/jquery.range.js"></script>
	<script src="js/index.js"></script>
	<script type="text/javascript">
		$(function  () {
			basemap = "http://221.238.40.122:8399/arcgis/rest/services/FJYXFW/MapServer";
			querymap = 'http://221.238.40.122:8399/arcgis/rest/services/FJXX/MapServer/0';
			ecomap = "http://221.238.40.122:8399/arcgis/rest/services/SQEcoMap/MapServer";
			var kfsObj = {};
			var avgPrice = {
			    "和畅园": 7300,
			    "鲲玺园": 8000,
			    "荣馨园": 8300,
			    "红树湾花园": 8500,
			    "兰苑": 8900,
			    "美林园": 9000,
			    "悦馨苑": 9000,
			    "鲲贝园": 9200,
			    "雅境园": 9200,
			    "首玺园": 9500,
			    "季景园": 9850,
			    "天和园": 10000,
			    "鲲玉园": 10000,
			    "家和园": 10000,
			    "美韵园": 10000,
			    "景杉园": 10300,
			    "锦庐园": 11000,
			    "尚苑": 11000,
			    "新新家园": 11000,
			    "璟苑": 11000,
			    "兰景园": 12500,
			    "芦花庄园": 14000,
			    "南苑": 14500,
			    "新颐园": 16500,
			    "依水园": 16500,
			    "澜水苑": 17500,
			    "香堤苑": 21500,
			    "建设公寓": 9000,
			    "世茂生态城": 9000,
			    "金航湾": 9000,
			    "蓝领公寓": 9000,
			    "宝龙欧洲城": 9000,
			    "碧桂园·滨海城": 9000,
			    "力高·阳光海岸": 9000,
			    "芙蓉北苑": 9000,
			    "芙蓉南苑": 9000,
			    "首创康桥郡": 9000,
			    "煦园": 9000
			};
			var rentingObj = {
			    "宝龙欧洲城": 1700,
			    "碧桂园·滨海城": 2100,
			    "和畅园": 1967,
			    "红树湾花园": 2880,
			    "季景园": 2262,
			    "家和园": 2100,
			    "锦庐园": 3680,
			    "景杉园": 2150,
			    "鲲贝园": 2350,
			    "鲲玺园": 2233,
			    "鲲玉园": 2025,
			    "兰苑": 3200,
			    "美林园": 2467,
			    "美韵园": 2200,
			    "荣馨园": 1200,
			    "尚苑": 1900,
			    "仕景苑": 2300,
			    "首玺园": 2100,
			    "天和园": 2200,
			    "新新家园": 2800,
			    "雅境园": 1933,
			    "悦馨苑": 2300
			};
			var rentingHouseArr = ["宝龙欧洲城", "碧桂园·滨海城", "和畅园", "红树湾花园", "季景园", "家和园", "锦庐园", "景杉园", "鲲贝园", "鲲玺园", "鲲玉园", "兰苑", "美林园", "美韵园", "荣馨园", "尚苑", "仕景苑", "首玺园", "天和园", "新新家园", "雅境园", "悦馨苑"];
			var imgArr = [
				"imgs/a.jpg",
				"imgs/b.jpg",
				"imgs/c.jpg",
				"imgs/d.jpg",
				"imgs/e.jpg",
				"imgs/f.jpg",
				"imgs/g.jpg",
				"imgs/h.jpg"
			];
			var ruzhulvRate = {
			    "嘉铭": 78,
			    "世茂": 100,
			    "吉宝": 99,
			    "建投": 98,
			    "天房": 97,
			    "万通": 96,
			    "生井": 95,
			    "万科": 94,
			    "远雄": 93,
			    "投资": 92,
			    "阿亚拉": 88,
			    "美利丰": 86,
			    "生星": 80,
			    "双威": 79,
			    "生态投资": 76,
			    "航天": 75,
			    "众美": 70,
			    "富龙": 68,
			    "亿利": 66,
			    "富士": 65,
			    "碧桂园": 60,
			    "新苑投资": 59,
			    "力高": 55,
			    "宝龙": 50
			};
			var xiaoshoulvRate = {
			    "嘉铭": 78,
			    "世茂": 100,
			    "吉宝": 99,
			    "建投": 98,
			    "天房": 97,
			    "万通": 96,
			    "生井": 95,
			    "万科": 94,
			    "远雄": 93,
			    "投资": 92,
			    "阿亚拉": 88,
			    "美利丰": 86,
			    "生星": 80,
			    "双威": 79,
			    "生态投资": 76,
			    "航天": 75,
			    "众美": 70,
			    "富龙": 68,
			    "亿利": 66,
			    "富士": 65,
			    "碧桂园": 60,
			    "新苑投资": 59,
			    "力高": 55,
			    "宝龙": 50
			};
			var graphicFeaturesArr;
			var parkgraphicsLayer;


			require([
			"esri/map","esri/symbols/PictureFillSymbol", "esri/Color", "esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleMarkerSymbol", "esri/tasks/QueryTask","esri/tasks/query","esri/layers/GraphicsLayer","esri/graphicsUtils","esri/symbols/PictureMarkerSymbol","esri/graphic", "esri/layers/FeatureLayer", "esri/layers/ArcGISTiledMapServiceLayer", "esri/geometry/Extent", "esri/layers/ArcGISImageServiceLayer",
			"esri/layers/ImageServiceParameters", "dojo/parser", "dojo/domReady!"
			], function(
			Map,PictureFillSymbol, Color, SimpleLineSymbol, SimpleMarkerSymbol, QueryTask, Query,GraphicsLayer,graphicsUtils,PictureMarkerSymbol,Graphic, FeatureLayer, ArcGISTiledMapServiceLayer, Extent, ArcGISImageServiceLayer,
			ImageServiceParameters, parser
			) {
				chart4();
				var ext = new Extent({
					xmin:117.59786569023996,
					ymin:39.06854167659476,
					xmax:117.82629394679967,
					ymax:39.19382029855173
				});

				map = new Map("ecomap",{
						  nav:false,//8个pan 箭头
						  slider:false,//左上的缩放 +/-;
						  logo:false,//右下的esri logo
						  showAttribution:false,//右下的gisNeu (logo左侧)
						  extent: ext
						});
				var ecomap = new ArcGISTiledMapServiceLayer(basemap);
				map.addLayer(ecomap);

				genColor = [255, 0, 0, 0.9];
				genSize = 16;

				var estateArr = ['和畅园','美林园','天和园','芦花庄园','锦庐园','南苑','兰苑','荣馨园','首玺园','尚苑','建设公寓','世茂生态城','金航湾','蓝领公寓','宝龙欧洲城','碧桂园•滨海城','力高•阳光海岸','新新家园','季景园','鲲玉园','鲲贝园','景杉园','香堤苑','鲲玺园','红树湾花园','芙蓉北苑','雅境园','芙蓉南苑','家和园','悦馨苑','兰景园','美韵园','璟苑','新颐园','依水园','首创康桥郡','澜水苑','煦园',"颐湖居","慧水苑","雅馨园"];

				var queryCondition = "DM in ('宝龙欧洲城', '碧桂园·滨海城', '和畅园', '红树湾花园', '季景园', '家和园', '锦庐园', '景杉园', '鲲贝园', '鲲玺园', '鲲玉园', '兰苑', '美林园', '美韵园', '荣馨园', '尚苑', '仕景苑', '首玺园', '天和园', '新新家园', '雅境园', '悦馨苑')";

				// var queryCondition = "DM in ('和畅园','颐湖居','慧水苑','雅馨园','美林园','天和园','芦花庄园','锦庐园','南苑','兰苑','荣馨园','首玺园','尚苑','建设公寓','世茂生态城','金航湾','蓝领公寓','宝龙欧洲城','碧桂园•滨海城','力高•阳光海岸','新新家园','季景园','鲲玉园','鲲贝园','景杉园','香堤苑','鲲玺园','红树湾花园','芙蓉北苑','雅境园','芙蓉南苑','家和园','悦馨苑','兰景园','美韵园','璟苑','新颐园','依水园','首创康桥郡','澜水苑','煦园')";

				// var queryCondition = "KFS='宝龙'"

				queryMap(queryCondition, genSize, genColor);

				function queryMap(queryCondition, genSize, genColor ) {
					if(typeof parkgraphicsLayer != "undefined"){
						map.removeLayer(parkgraphicsLayer);
					}

					var qt = new QueryTask(querymap);
					var query = new Query();
					query.returnGeometry = true;
					query.outFields = ["*"];
					//query.outSpatialReference = map.spatialReference;
					query.where = queryCondition;

					parkgraphicsLayer = new GraphicsLayer();

					qt.execute(query,function(results){
						var parkgraphicsAry = results.features;
						graphicFeaturesArr = results.features;
						var html = '';
						$("#listContent").empty();
						kfsObj = {};
						if(results.features.length == 0) {
							alert("你所输入的信息可能有误，系统无法为您查询到结果，请核对后输入！");
						}
				    	for (var i=0;i<results.features.length; i++)
						{
							var graphic=results.features[i];

							var mc = results.features[i]["attributes"]["DM"];
							var kfs = results.features[i]["attributes"]["KFS"];

							kfsObj[mc] = kfs;

							if(rentingHouseArr.indexOf(mc) < 0) {
								graphic.setSymbol(genCircleSymbol(genSize, genColor));
							}else {
								graphic.setSymbol(genCircleSymbol(genSize, [0, 255, 0, 0.9]));
							}

							parkgraphicsLayer.add(graphic);

							html += '<div class="cs-img-block">';
							html += '<img src="'+ (i<8?imgArr[i]:'imgs/a.jpg') + '" style="max-width:100%">';
							html += '<h3 class="cs-img-h3">'+ mc +'</h3>';
							html += '<p class="cs-img-p">&yen;'+(typeof Math.round(rentingObj[mc]) == 'undefined'?'2000':Math.round(rentingObj[mc]))+'</p>';
							html += '<div class="cs-img-mask" data-housename="'+mc+'"></div></div>';
						}
						$("#listContent").append(html);

					},function(){
						alert("查询错误");
					});

					map.addLayer(parkgraphicsLayer);

					parkgraphicsLayer.on("click",function (e) {
						var graphic = e.graphic;
						var mc = graphic.attributes["DM"];
						var kfs = graphic.attributes["KFS"];

						for (var i=0;i<graphicFeaturesArr.length; i++)
						{
							genColor = [255, 0, 0, 0.9];
							genSize = 16;
							var agraphic=graphicFeaturesArr[i];

							if(rentingHouseArr.indexOf(mc) < 0) {
								agraphic.setSymbol(genCircleSymbol(genSize, genColor));
							}else {
								agraphic.setSymbol(genCircleSymbol(genSize, [0, 255, 0, 0.9]));
							}
						}

						genColor = [0, 0, 255, 0.9];
						genSize = 16;

						graphic.setSymbol(genCircleSymbol(genSize, genColor));

						$("#listContentBox").css({
							display:"none"
						});
						$('.cs-img-mask').css({
						    "background": "transparent",
						    "border": "0"
						});
						$("[data-housename='"+mc+"']").css({
						    "background": "rgba(0, 0, 0, 0.15)",
						    "border": "2px solid rgba(0, 204, 204, .5)"
						});
						$('#detailContent').empty();
						$('#detailContent').css({
							display:"block"
						});
						var houseName = mc;
						var html = '';
						html += '<div id="returnBtn">';
						html += '<div class="cs-returnBtn">返回</div></div>';
						html += '<table class="cs-detail-table" cellspacing="0">';
						html += '<tr><td>小区名称</td><td>开发商</td><td>上市套数</td><td>成交套数</td><td>平均价格</td><td>入住率</td></tr>';
						html += '<tr><td>'+houseName+'</td><td>'+kfs+'</td><td>1000</td><td>1000</td>';
						html += '<td>'+(typeof Math.round(rentingObj[houseName]) == 'undefined'?'2000':Math.round(rentingObj[houseName]))+'</td><td>90%</td></tr></table>';
						html += '<div id="chart1"></div>';
						html += '<div id="chart2"></div>';
						html += '<div id="chart3"></div>';

						$('#detailContent').append(html);

						chart1();
						chart2();
						chart3();
					});
				}

			$("#listContent").on("click",".cs-img-mask",function(){
				$("#listContentBox").css({
					display:"none"
				});
				$('#detailContent').empty();
				$('#detailContent').css({
					display:"block"
				});
				$('.cs-img-mask').css({
				    "background": "transparent",
				    "border": "0"
				});
				$(this).css({
				    "background": "rgba(0, 0, 0, 0.15)",
				    "border": "2px solid rgba(0, 204, 204, .5)"
				});
				var houseName = $(this).attr("data-housename");
				var html = '';
				html += '<div id="returnBtn">';
				html += '<div class="cs-returnBtn">返回</div></div>';
				html += '<table class="cs-detail-table" cellspacing="0">';
				html += '<tr><td>小区名称</td><td>开发商</td><td>上市套数</td><td>成交套数</td><td>平均价格</td><td>入住率</td></tr>';
				html += '<tr><td>'+houseName+'</td><td>'+kfsObj[houseName]+'</td><td>1000</td><td>1000</td>';
				html += '<td>'+(typeof Math.round(rentingObj[houseName]) == 'undefined'?'2000':Math.round(rentingObj[houseName]))+'</td><td>90%</td></tr></table>';
				html += '<div id="chart1"></div>';
				html += '<div id="chart2"></div>';
				html += '<div id="chart3"></div>';

				$('#detailContent').append(html);

				chart1();
				chart2();
				chart3();

				for (var i=0;i<graphicFeaturesArr.length; i++)
				{
					var agraphic=graphicFeaturesArr[i];
					var mc = agraphic.attributes["DM"];
					if(mc == houseName){
						genColor = [0, 0, 255, 0.9];
						genSize = 16;
						agraphic.setSymbol(genCircleSymbol(genSize, genColor));
					}else {
						genColor = [255, 0, 0, 0.9];
						genSize = 16;
						agraphic.setSymbol(genCircleSymbol(genSize, genColor));
						if(rentingHouseArr.indexOf(mc) < 0) {
							agraphic.setSymbol(genCircleSymbol(genSize, genColor));
						}else {
							agraphic.setSymbol(genCircleSymbol(genSize, [0, 255, 0, 0.9]));
						}
					}
				}

			});

			$("#detailContent").on("click",".cs-returnBtn",function(){
				$("#detailContent").css({
					display:"none"
				});
				$('#listContentBox').css({
					display:"block"
				});
			});
			$("#search-button").click(function () {
				var val = $("#sole-input").val();
				var queryCondition101 = "DM='"+val+"' or KFS='"+val+"'";
				var genColor = [255, 0, 0, 0.9];
				var genSize = 16;
				$("#detailContent").css({
					display:"none"
				});
				$('#listContentBox').css({
					display:"block"
				});
				if(val == ''){
					queryMap(queryCondition, genSize, genColor);
				}else {
					queryMap(queryCondition101, genSize, genColor);
				}
			});
			$('#sole-input').on('keypress',function(event){
			    if(event.keyCode == "13") {
			    	$('#search-button').click();
			    }
			});

			// var rangeBoxWidth = Math.round($("#filterBox").width()*0.82);

			setTimeout(function(){
				var minRentVal = Math.min.apply(null, getObjectValues(rentingObj));
				var maxRentVal = Math.max.apply(null, getObjectValues(rentingObj));
				$("#id-span-price-min span").html(minRentVal);
    			$("#id-span-price-max span").html(maxRentVal);

    			$('.ruzhulv-range-slider').jRange({
				    from: 0,
				    to: 100,
				    step: 1,
				    format: '%s',
				    // width:300,
				    width: Math.round($(".cs-more-filter").width()*0.6),
				    showLabels: true,
				    showScale: false,
				    isRange : true,
				    onstatechange: function () {
				    	
				    },
				    ondragend: function () {
				    	
				    }
				});

				$('.xiaoshoulv-range-slider').jRange({
				    from: 0,
				    to: 100,
				    step: 1,
				    format: '%s',
				    // width:300,
				    width: Math.round($(".cs-more-filter").width()*0.6),
				    showLabels: true,
				    showScale: false,
				    isRange : true,
				    onstatechange: function () {
				    	
				    },
				    ondragend: function () {
				    	
				    }
				});

				

				$('.range-slider').jRange({
				    from: 0,
				    to: maxRentVal - minRentVal,
				    step: 1,
				    format: '%s',
				    // width:300,
				    width: Math.round($(".rangeBox").width()),
				    showLabels: false,
				    showScale: false,
				    isRange : true,
				    // theme : 'theme-green',
				    onstatechange: function () {
				    	var valArr = $(".range-slider").val().split(',');
				    	if(typeof valArr[0] != 'undefined' && typeof valArr[1] != 'undefined' ){
				    		if(valArr[0] != 0){
				    			$("#id-span-price-min span").html(parseInt(valArr[0]) + minRentVal);
				    			$("#id-span-price-max span").html(parseInt(valArr[1]) + minRentVal);
				    		}else if(valArr[0] == 0){
				    			$("#id-span-price-min span").html(minRentVal);
				    		}

				    	}
				    	console.log($(".range-slider").val());
				    },
				    ondragend: function () {
				    	var minVal = $("#id-span-price-min span").text();
				    	var maxVal = $("#id-span-price-max span").text();
				    	if(typeof minVal != 'undefined' && typeof maxVal != 'undefined' ){
				    		minVal = parseInt(minVal);
				    		maxVal = parseInt(maxVal.split('+')[0]);
				    		queryMap(getAmongPriceHouse(minVal, maxVal), genSize, [0, 255, 0, 0.9]);
				    	}
				    	console.log(minVal);
				    	console.log(maxVal);

				    	// console.log($(".range-slider").val());
				    }
				});
			}, 0);

			function getAmongPriceHouse(minVal, maxVal) {
				// var queryCondition = "DM in ('宝龙欧洲城', '碧桂园·滨海城', '和畅园', '红树湾花园', '季景园', '家和园', '锦庐园', '景杉园', '鲲贝园', '鲲玺园', '鲲玉园', '兰苑', '美林园', '美韵园', '荣馨园', '尚苑', '仕景苑', '首玺园', '天和园', '新新家园', '雅境园', '悦馨苑')";
				var queryStr = "DM in (";
				for (rent in rentingObj){
					if(rentingObj[rent] >= minVal && rentingObj[rent] <= maxVal){
						queryStr += "'";
						queryStr += rent;
						queryStr += "'";
						queryStr += ",";
					}
				}
				if(queryStr.indexOf(",") >= 0){
					queryStr = queryStr.substring(0,queryStr.length - 1);
				}else {
					queryStr += "''";
				}

				queryStr += ")";
				console.log(queryStr);
				return queryStr;
			}

			function getObjectValues(obj) {
				var values = [];
				for(var pro in obj){
					values.push(obj[pro]);
				}
				return values;
			}

			function genCircleSymbol (size, color) {
				return new SimpleMarkerSymbol(
		          SimpleMarkerSymbol.STYLE_CIRCLE,
		          size,
		          new SimpleLineSymbol(
		            SimpleLineSymbol.STYLE_NULL,
		            new Color([247, 34, 101, 0.9]),
		            1
		          ),
		          new Color(color)
		        );
			}
			});
		});
	</script>
</head>
<body>
	<div id="ecomap"></div>
	<div id="searchbar">
		<input id="sole-input" class="searchbox-content-common" type="text" name="word" autocomplete="off" maxlength="256" placeholder="查找小区，请输入小区或开发商名称" value="">
		<button id="search-button" data-title="搜索" ></button>
	</div>
	<div id="content">
		<div id="listContentBox" >
			<div class="cs-kfs-box clearfloat">
				<h3 class="filter-h3">筛选条件</h3>
				<div class="cs-more-filter">
					<label for="input-ruzhulv">入住率(%)</label>
					<div class="more-filter-range-box">
						<input type="hidden" class="ruzhulv-range-slider" value="100" />
					</div>
				</div>
				<div class="cs-more-filter">
					<label for="input-xiaoshoulv">销售率(%)</label>
					<div class="more-filter-range-box">
						<input type="hidden" class="xiaoshoulv-range-slider" value="100" />
					</div>
				</div>
				<div class="cs-more-filter">
					<label for="input-kfs">开发商</label>
					<div class="cs-ui-select">
				        <span>全部</span>
				        <select name="input-kfs" id="id-input-kfs">
							<option>全部</option>
							<option>嘉铭</option>
							<option>世茂</option>
							<option>吉宝</option>
							<option>建投</option>
							<option>天房</option>
							<option>万通</option>
							<option>生井</option>
							<option>万科</option>
							<option>远雄</option>
							<option>投资</option>
							<option>阿亚拉</option>
							<option>美利丰</option>
							<option>生星</option>
							<option>双威</option>
							<option>生态投资</option>
							<option>航天</option>
							<option>众美</option>
							<option>富龙</option>
							<option>亿利</option>
							<option>富士</option>
							<option>碧桂园</option>
							<option>新苑投资</option>
							<option>力高</option>
							<option>宝龙</option>
						</select>
				    </div>
				</div>
			</div>
			<hr>
			<div id="filterBox">
				<div id="chart4"></div>
				<div class="rangeBox">
					<input type="hidden" class="range-slider" value="10000" />
				</div>
				<span class="cs-span-price" id="id-span-price-min">&yen;<span>500</span></span>
				<span class="cs-span-price cs-span-price-right" id="id-span-price-max">&yen;<span>5000+</span></span>
			</div>
			<hr>
			<div id="listContent" class="clearfloat"></div>
		</div>
		<div id="detailContent" class="clearfloat"></div>
	</div>
</body>
</html>
<!-- <div id="returnBtn">
		<div class="cs-returnBtn">返回</div>
</div>
<table class="cs-detail-table" cellspacing="0">
	<tr>
		<td>小区名称</td>
		<td>开发商</td>
		<td>上市套数</td>
		<td>成交套数</td>
		<td>平均价格</td>
		<td>入住率</td>
	</tr>
	<tr>
		<td>和畅园</td>
		<td>投资</td>
		<td>1000</td>
		<td>1000</td>
		<td>8000</td>
		<td>90%</td>
	</tr>
</table>
<div id="chart1"></div>
<div id="chart2"></div>
<div id="chart3"></div> -->